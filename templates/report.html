<!doctype html>
<html>
<head>
<link rel="icon" type="image/png" href="/static/favicon.png">
  <meta charset="utf-8">
  <title>Analysis Result</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

  <style>
    :root {
      --bg: #f9fafc;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --primary: #0078ff;
      --primary-hover: #005fcc;
      --success-bg: #e8f7ee;
      --success-text: #0a6b2e;
      --error-bg: #fdecea;
      --error-text: #a1271d;
      --warn-bg: #fff8e1;
      --warn-text: #a68a00;
    }
    body {
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 40px auto;
      max-width: 1200px;
      color: #111827;
    }
    h1 {
      text-align: center;
      color: #111;
      font-size: 28px;
      margin-bottom: 24px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 24px 28px;
      margin-bottom: 20px;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin: 10px 0 20px;
    }
    li { padding: 4px 0; }

    .status {
      padding: 6px 10px;
      border-radius: 6px;
      display: inline-block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    .done { background: var(--success-bg); color: var(--success-text); }
    .error { background: var(--error-bg); color: var(--error-text); }
    .queued, .running { background: var(--warn-bg); color: var(--warn-text); }

    a.btn {
      display: inline-block;
      background: var(--primary);
      color: #fff;
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
      margin-right: 8px;
    }
    a.btn:hover { background: var(--primary-hover); }

    footer {
      text-align: center;
      margin-top: 28px;
    }
    footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    footer a:hover { text-decoration: underline; }
    
    .chart-section {
        margin-top: 24px; 
        border-top: 1px solid #eee; 
        padding-top: 16px;
    }
    .chart-header {
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
        margin-bottom:10px;
    }
    .chart-controls {
        display: flex;
        gap: 6px;
    }
    .chart-box {
        position: relative; 
        height: 300px; 
        width: 100%;
    }
    .reset-btn {
        cursor: pointer;
        padding: 4px 10px;
        font-size: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        color: #555;
    }
    .reset-btn:hover {
        background-color: #f3f3f3;
        border-color: #ccc;
    }
  </style>

  {% if r.status != 'done' %}
  <script>
    setTimeout(() => location.reload(), 3000);
  </script>
  {% endif %}
  
  <script>
      // 차트 숨기기/보이기 토글 함수
      function toggleChart(boxId, btn) {
          const box = document.getElementById(boxId);
          if (box.style.display === 'none') {
              box.style.display = 'block';
              btn.innerText = 'Hide Chart';
          } else {
              box.style.display = 'none';
              btn.innerText = 'Show Chart';
          }
      }
  </script>
</head>
<body>
  <h1>Analysis Result</h1>

  <div class="card">
    <p>
      <span class="status {{ r.status|e }}">
        Status: {{ r.status|capitalize }}
        {% if r.status == 'error' and r.error %} — {{ r.error }}{% endif %}
      </span>
    </p>

    <ul>
      <li><b>Filename:</b> {{ r.filename }}</li>
      <li><b>Upload Time (UTC):</b> {{ r.uploaded_at }}</li>
      <li><b>Total Epochs:</b> {{ r.epoch_total }}</li>
      <li><b>Missing Epochs:</b> {{ r.epoch_missing }}</li>
      </ul>

    <h3>KMZ / Map</h3>
    <ul>
      <li>
        {% if r.kmz_path %}
          <a class="btn" href="/download?path={{ r.kmz_path|urlencode }}">Download KMZ</a>
          <a class="btn" href="/map/{{ r.id }}" target="_blank">View on Map</a>
        {% elif r.status in ['queued','running'] %}
          <span class="status running">Processing… (auto-refreshing)</span>
        {% else %}
          <span class="status error">Not generated{% if r.error %}: {{ r.error }}{% endif %}</span>
        {% endif %}
      </li>
    </ul>

    {% if graph_data %}
    <div class="chart-section">
      <div class="chart-header">
        <h3 style="margin:0;">Position Accuracy (2D vs 3D)</h3>
        <div class="chart-controls">
            <button class="reset-btn" onclick="toggleChart('accChartBox', this)">Hide Chart</button>
            <button class="reset-btn" onclick="resetAllZooms()">Reset All</button>
        </div>
      </div>
      <p style="font-size:12px; color:#666; margin-top:0;">* Scroll to zoom, Drag to pan (Synced)</p>
      <div class="chart-box" id="accChartBox">
        <canvas id="accChart"></canvas>
      </div>
    </div>
    {% endif %}

    {% if graph_data and graph_data.fix_type %}
    <div class="chart-section">
      <div class="chart-header">
        <h3 style="margin:0;">Fix Type Status</h3>
        <div class="chart-controls">
            <button class="reset-btn" onclick="toggleChart('fixChartBox', this)">Hide Chart</button>
            <button class="reset-btn" onclick="resetAllZooms()">Reset All</button>
        </div>
      </div>
      <div class="chart-box" id="fixChartBox" style="height: 200px;">
        <canvas id="fixChart"></canvas>
      </div>
    </div>
    {% endif %}

    {% if graph_data and graph_data.cno_scatter and graph_data.cno_scatter|length > 0 %}
    <div class="chart-section">
      <div class="chart-header">
        <h3 style="margin:0;">Satellite Signal Density (CN0)</h3>
        <div class="chart-controls">
            <button class="reset-btn" onclick="toggleChart('cnoChartBox', this)">Hide Chart</button>
            <button class="reset-btn" onclick="resetAllZooms()">Reset All</button>
        </div>
      </div>
      <p style="font-size:12px; color:#666; margin-top:0;">* Green Line: Top 5 Avg | Blue Dots: Individual Satellites</p>
      
      <div class="chart-box" id="cnoChartBox" style="height: 350px;">
        <canvas id="cnoChart"></canvas>
      </div>
    </div>
    {% endif %}
  </div>

  <footer>
    <p><a href="/recent">← Back to Recent Results</a> | <a href="/">Upload Another File</a></p>
  </footer>

{% if graph_data %}
  <script>
    let accChartInstance = null;
    let fixChartInstance = null;
    let cnoChartInstance = null;

    const FIXED_Y_WIDTH = 85; 

    // 데이터 로드
    const gData = {{ graph_data | tojson }};
    
    // 데이터의 시작과 끝 계산
    const xLabels = gData.labels;
    const minX = xLabels.length > 0 ? xLabels[0] : null;
    const maxX = xLabels.length > 0 ? xLabels[xLabels.length - 1] : null;

    // [수정됨] iTOW -> UTC 시간 변환 함수 (요일 제거, 시간만 표시)
    function formatITOW(itow) {
        if (itow == null) return '';
        // GPS Time -> UTC (approx -18s)
        let ms = itow - 18000; 
        if (ms < 0) ms += 604800000; // 주 넘김 보정

        // 하루(86400초) 내에서의 초 계산
        const totalSec = Math.floor(ms / 1000);
        const rem = totalSec % 86400;
        
        const hh = Math.floor(rem / 3600).toString().padStart(2, '0');
        const mm = Math.floor((rem % 3600) / 60).toString().padStart(2, '0');
        const ss = (rem % 60).toString().padStart(2, '0');
        
        return `${hh}:${mm}:${ss}`;
    }

    // 동기화 함수
    function syncCharts(sourceChart) {
        const x = sourceChart.scales.x;
        if (!x) return;
        const min = x.min;
        const max = x.max;
        
        const charts = [accChartInstance, fixChartInstance, cnoChartInstance];
        charts.forEach(chart => {
            if (chart && chart !== sourceChart && chart.scales.x) {
                chart.options.scales.x.min = min;
                chart.options.scales.x.max = max;
                chart.update('none');
            }
        });
    }

    // 줌 리셋 함수
    function resetAllZooms() {
        const charts = [accChartInstance, fixChartInstance, cnoChartInstance];
        charts.forEach(c => {
            if(c) {
                c.resetZoom(); 
                c.options.scales.x.min = minX;
                c.options.scales.x.max = maxX;
                c.update(); 
            }
        });
    }

    const zoomOptions = {
        pan: { 
            enabled: true, mode: 'x',
            onPan: ({chart}) => syncCharts(chart) 
        },
        zoom: {
          wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x',
          onZoom: ({chart}) => syncCharts(chart)
        },
        limits: { x: { min: minX, max: maxX, minRange: 1000 } }
    };

    // 공통 X축 설정 (UTC 시간 라벨 추가)
    const commonScalesX = {
        type: 'linear',
        min: minX,
        max: maxX,
        ticks: { 
            maxTicksLimit: 8,
            callback: function(value) {
                // iTOW값 아래에 (HH:MM:SS) 시간 표시
                return [value, `(${formatITOW(value)})`];
            }
        }, 
        grid: { display: false },
        title: { display: true, text: 'iTOW (ms) / UTC Time' }
    };

    // 공통 툴팁 설정
    const commonTooltip = {
        mode: 'index', 
        intersect: false,
        callbacks: {
            title: function(context) {
                const val = context[0].parsed.x;
                return `iTOW: ${val}  |  UTC: ${formatITOW(val)}`;
            }
        }
    };

    // 1. Accuracy Chart
    const ctxAcc = document.getElementById('accChart').getContext('2d');
    accChartInstance = new Chart(ctxAcc, {
      type: 'line',
      data: {
        labels: gData.labels,
        datasets: [
          {
            label: '2D Accuracy (m)',
            data: gData.acc2d,
            borderColor: '#0078ff',
            backgroundColor: 'rgba(0, 120, 255, 0.1)',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 4,
            tension: 0.1
          },
          {
            label: '3D Accuracy (m)',
            data: gData.acc3d,
            borderColor: '#ff4d4d',
            backgroundColor: 'rgba(255, 77, 77, 0.1)',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 4,
            tension: 0.1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'top' },
          tooltip: commonTooltip,
          zoom: zoomOptions
        },
        scales: {
          x: commonScalesX,
          y: { 
            beginAtZero: true, 
            title: { display: true, text: 'Accuracy (meters)' },
            afterFit: (ctx) => { ctx.width = FIXED_Y_WIDTH; }
          }
        }
      }
    });

    // 2. Fix Type Chart
    if (gData.fix_type && gData.fix_type.length > 0) {
      const ctxFix = document.getElementById('fixChart').getContext('2d');
      fixChartInstance = new Chart(ctxFix, {
        type: 'line',
        data: {
          labels: gData.labels,
          datasets: [{
            label: 'Fix Type',
            data: gData.fix_type,
            borderColor: '#9d7bff',
            backgroundColor: 'rgba(157, 123, 255, 0.1)',
            borderWidth: 2,
            stepped: true, 
            pointRadius: 0,
            pointHoverRadius: 4,
            tension: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: false }, 
            tooltip: {
              ...commonTooltip,
              callbacks: {
                ...commonTooltip.callbacks,
                label: function(context) {
                  const map = {0:'No fix', 1:'DR', 2:'2D', 3:'3D', 4:'GNSS+DR', 5:'Time'};
                  return (map[context.raw] || context.raw);
                }
              }
            },
            zoom: zoomOptions
          },
          scales: {
            x: commonScalesX,
            y: {
              min: 0, max: 5,
              ticks: {
                stepSize: 1,
                callback: function(val) {
                  const map = {0:'No fix', 1:'DR', 2:'2D', 3:'3D', 4:'GNSS+DR', 5:'Time'};
                  return map[val] !== undefined ? map[val] : '';
                }
              },
              title: { display: true, text: 'Fix Type' },
              afterFit: (ctx) => { ctx.width = FIXED_Y_WIDTH; }
            }
          }
        }
      });
    }

    // 3. CN0 Chart
    const cnoCanvas = document.getElementById('cnoChart');
    if (cnoCanvas && gData.cno_scatter && gData.cno_scatter.length > 0) {
        const ctxCno = cnoCanvas.getContext('2d');
        cnoChartInstance = new Chart(ctxCno, {
          data: {
            labels: gData.cno_labels || gData.labels, 
            datasets: [
              {
                type: 'line',
                label: 'Top 5 Avg (Quality)',
                data: gData.cno_top_avg,
                borderColor: '#00E676',
                borderWidth: 2,
                pointRadius: 0,
                tension: 0,
                order: 1,
                spanGaps: true
              },
              {
                type: 'scatter',
                label: 'Satellite Signal',
                data: gData.cno_scatter,
                backgroundColor: 'rgba(33, 150, 243, 0.15)', 
                pointRadius: 1.5,
                pointHoverRadius: 2,
                borderWidth: 0,
                order: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            normalized: true,
            interaction: { mode: 'nearest', intersect: false, axis: 'x' },
            plugins: {
              legend: { position: 'top' },
              tooltip: commonTooltip,
              zoom: zoomOptions
            },
            scales: {
              x: commonScalesX,
              y: {
                beginAtZero: true,
                suggestedMax: 60,
                title: { display: true, text: 'CN0 (dBHz)' },
                afterFit: (ctx) => { ctx.width = FIXED_Y_WIDTH; }
              }
            }
          }
        });
    }
  </script>
  {% endif %}
</body>
</html>